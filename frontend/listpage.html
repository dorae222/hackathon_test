<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì¶”ì²œ ê²°ê³¼ - ë‚˜ì˜ ìš´ëª…ì˜ ê°•ì•„ì§€ ì°¾ê¸°</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        html, body { margin: 0; font-family: 'Pretendard', sans-serif; background-color: #FFFBF5; display: flex; justify-content: center; padding-top: 40px; padding-bottom: 40px; }
    .screen-container { background-color: white; border-radius: 20px; padding: 30px 20px; width: 100%; max-width: 420px; box-sizing: border-box; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.07); position: relative; }
        .header-title { font-size: 24px; font-weight: 900; text-align: center; margin-bottom: 25px; color: #333; }
    .slider-wrapper { overflow: hidden; position: relative; }
    .slider-track { display: flex; transition: transform 0.45s ease; }
    .result-card { flex: 0 0 100%; background-color: #ffffff; border: 1px solid #eee; border-radius: 18px; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06); overflow: hidden; }
    .result-card img { width: 100%; height: 250px; object-fit: cover; }
    .card-content { padding: 20px; position: relative; }
        .card-content h3 { margin: 0 0 15px 0; font-size: 22px; font-weight: bold; text-align: center; }
        .similarity-score { background-color: #FFF5E1; border-radius: 10px; padding: 12px; font-weight: bold; text-align: center; margin-bottom: 18px; font-size: 16px; }
        .similarity-score .label { font-size: 13px; font-weight: 500; display: block; margin-top: 4px; }
        .matching-points { font-size: 14px; text-align: center; margin-bottom: 20px; background-color: #f7f7f7; padding: 12px; border-radius: 10px; }
        .matching-points strong { display: block; margin-bottom: 8px; font-size: 15px; }
        .matching-points .tag { background-color: #e7e7e7; border-radius: 5px; padding: 4px 10px; font-size: 13px; font-weight: 500; margin: 0 3px; display: inline-block; }
    .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 12px; background-color: #FF7A00; color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
    .btn:hover { background-color: #E66A00; }
    /* Navigation controls repositioned below slider to avoid overlapping image */
    .slider-controls { display: flex; align-items: center; justify-content: center; gap: 14px; margin: 12px 0 18px; }
    .nav-btn { position: static; transform: none; background: #ffffff; border: 1px solid #ddd; width: 40px; height: 40px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: background-color .18s, border-color .18s; }
    .nav-btn:hover { background: #FF7A00; color: #fff; border-color: #FF7A00; }
    .dots { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .dots button { width: 10px; height: 10px; border-radius: 50%; border: none; background: #d4d4d4; cursor: pointer; transition: background-color .25s, transform .25s; }
    .dots button.active { background: #FF7A00; transform: scale(1.2); }
    @media (max-width: 430px){
        .nav-btn { width:36px; height:36px; font-size:18px; }
    }
    </style>
</head>
<body>
    <script>
        // Auto-append ?v=3 for cache busting if no query provided
        (function(){
            try {
                if (!window.location.search) {
                    const target = window.location.pathname + '?v=3';
                    window.history.replaceState(null,'', target);
                }
            } catch(e) { console.warn('[AI][WARN] version query append failed', e); }
        })();
    </script>
    <div class="screen-container">
        <h1 class="header-title">AIê°€ ì°¾ì•„ì¤€<br>ë‹¹ì‹ ì˜ ìš´ëª…ì ì¸ ì¹œêµ¬ë“¤ì´ì—ìš”!</h1>
        <div class="slider-wrapper">
            <div id="slider-track" class="slider-track"></div>
        </div>
        <div class="slider-controls">
            <button class="nav-btn nav-prev" id="prevBtn" style="display:none;" aria-label="ì´ì „">â€¹</button>
            <div class="dots" id="dots" aria-label="ìŠ¬ë¼ì´ë“œ ìœ„ì¹˜ í‘œì‹œ"></div>
            <button class="nav-btn nav-next" id="nextBtn" style="display:none;" aria-label="ë‹¤ìŒ">â€º</button>
        </div>
    </div>

    <script>
        const AI_BASE = '/ai';
        function findField(infoArr, key){
            if (!Array.isArray(infoArr)) return '';
            for (const row of infoArr){
                if (row[0] === key) return row[1] || '';
                if (row[2] === key) return row[3] || '';
            }
            return '';
        }
        function renderCards(chosen, simMap, cls){
            const track = document.getElementById('slider-track');
            const dotsWrap = document.getElementById('dots');
            const norm = s => (s||'').toString().trim().toLowerCase().replace(/\s+/g,'');
            track.innerHTML='';
            dotsWrap.innerHTML='';
            chosen = chosen.slice(0,3);
            chosen.forEach((dog, idx)=>{
                let name, breed, age='', gender='', img='';
                let simPercent, simLabel, simText;
                if (dog.placeholder) {
                    breed = dog.breedLabel;
                    name = `${breed} í›„ë³´`;
                    img = '/assets/dog-placeholder.svg';
                    simPercent = dog.score;
                    simText = `ë‹®ì€ê¼´ ì§€ìˆ˜ ${simPercent}% !`;
                    simLabel = `í˜„ì¬ ë³´í˜¸ì†Œ ëª©ë¡ì— ${breed} ì—†ìŒ (ìœ ì‚¬ í’ˆì¢… ì¶”ì²œ)`;
                } else {
                    name = findField(dog.info,'ì´ë¦„') || 'ì´ë¦„ ë¯¸ìƒ';
                    breed = findField(dog.info,'í’ˆì¢…') || 'í’ˆì¢… ë¯¸ìƒ';
                    age = findField(dog.info,'ë‚˜ì´(ì¶”ì •)') || '';
                    gender = findField(dog.info,'ì„±ë³„') || '';
                    img = dog.thumbnail || (dog.gallery && dog.gallery[0]) || (dog.images_mapped && dog.images_mapped[0]) || (dog.images && dog.images[0]) || '';
                    const originalBreedKey = Object.keys(simMap).find(k => norm(k) === norm(breed));
                    simPercent = originalBreedKey ? simMap[originalBreedKey] : (idx===0 ? 80 : '');
                    simText = simPercent !== '' ? `ë‹®ì€ê¼´ ì§€ìˆ˜ ${simPercent}% !` : 'AI ì¶”ì²œ';
                    simLabel = (cls && cls.top && cls.top.length > 1)
                        ? `Top${cls.top.length} í›„ë³´ ì¤‘ ${idx+1}ìœ„`
                        : (cls && cls.top && cls.top.length === 1 ? `${cls.top[0]} ê¸°ë°˜ ì¶”ì²œ` : 'AI ë¶„ì„ ê¸°ë°˜');
                }
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <img src="${img}" alt="ê°•ì•„ì§€ ì‚¬ì§„" onerror="this.onerror=null; this.src='/assets/dog-placeholder.svg'">
                    <div class="card-content">
                        <h3>${name} (${age?age+', ':''}${breed}${gender?`, ${gender}`:''})</h3>
                        <div class="similarity-score" style="background-color:#E6F0FF;">âœ¨ ${simText}<span class="label">${simLabel}</span></div>
                        <div class="matching-points">
                            <strong>âœ”ï¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë§¤ì¹­ í¬ì¸íŠ¸</strong>
                            <div>
                                <span class="tag">#í™œë™ëŸ‰</span>
                                <span class="tag">#ì„±ê²©</span>
                            </div>
                        </div>
                        ${dog.placeholder ? '' : `<button class="btn chat-btn">${name}ì™€ ëŒ€í™”í•´ë³´ê¸° ğŸ’¬</button>`}
                    </div>`;
                track.appendChild(card);
                if (!dog.placeholder) {
                    card.querySelector('.chat-btn').addEventListener('click', ()=>{
                        window.location.href = `/chatbot.html?id=${dog.id}`;
                    });
                }
            });
            const total = track.children.length;
            if (total > 1){
                for (let i=0;i<total;i++){
                    const b=document.createElement('button');
                    if (i===0) b.classList.add('active');
                    b.addEventListener('click', ()=>{ current=i; update(); });
                    dotsWrap.appendChild(b);
                }
                document.getElementById('prevBtn').style.display='flex';
                document.getElementById('nextBtn').style.display='flex';
            }
            var current = 0;
            function update(){
                track.style.transform = `translateX(-${current*100}%)`;
                [...dotsWrap.children].forEach((d,i)=>{ d.classList.toggle('active', i===current); });
            }
            document.getElementById('prevBtn').onclick = ()=>{ current = (current-1+total)%total; update(); };
            document.getElementById('nextBtn').onclick = ()=>{ current = (current+1)%total; update(); };
            update();
        }
        function buildFromClassifyOnly(){
            let cls=null; try{cls=JSON.parse(sessionStorage.getItem('classifyResult')||'null');}catch{}
            if(!cls||!Array.isArray(cls.top)){console.warn('[AI][FALLBACK] classifyResult missing');return;}
            const simMap={};
            cls.top.forEach((b,i)=>{const percent=cls.scores&&cls.scores[i]!=null?Math.round(cls.scores[i]):0;simMap[b]=percent;});
            const placeholders = cls.top.slice(0,3).map((b,i)=>({id:`only-${i}`,placeholder:true,breedLabel:b,score:simMap[b]}));
            renderCards(placeholders, simMap, cls);
        }
        async function load(){
            console.log('[AI][INFO] load() start');
            const track = document.getElementById('slider-track');
            const dotsWrap = document.getElementById('dots');
            track.innerHTML='';
            dotsWrap.innerHTML='';
            const res = await fetch(`${AI_BASE}/animals`);
            let animals=[];
            try {
                animals = await res.json();
            } catch(e){
                console.error('[AI][ERROR] animals json parse failed', e);
            }
            console.log('[AI][DEBUG] animals length:', animals.length);

            let chosen = [];
            let cls, simMap = {};
            try { cls = JSON.parse(sessionStorage.getItem('classifyResult')||'null'); } catch {}
            console.log('[AI][DEBUG] classifyResult:', cls);

            const norm = s => (s||'').toString().trim().toLowerCase().replace(/\s+/g,'');

            const placeholders = [];
            if (cls && Array.isArray(cls.top)) {
                cls.top.forEach((breedLabel, idx) => {
                    const percent = cls.scores && cls.scores[idx] != null ? Math.round(cls.scores[idx]) : (cls.probs && cls.probs[breedLabel] ? Math.round(cls.probs[breedLabel]) : 0);
                    simMap[breedLabel] = percent;
                    const match = animals.find(a => norm(findField(a.info,'í’ˆì¢…')).includes(norm(breedLabel)));
                    if (match && !chosen.some(c => c.id === match.id)) {
                        chosen.push(match);
                    } else if (!match) {
                        // Breed not present in current ë³´í˜¸ì†Œ ë°ì´í„°: placeholder ìƒì„±
                        placeholders.push({
                            id: `placeholder-${idx}`,
                            placeholder: true,
                            breedLabel,
                            score: percent
                        });
                    }
                });
            }

            // Fallback / Fill to 3
            if (chosen.length === 0 && placeholders.length === 0) {
                console.log('[AI][DEBUG] No breed matches and no placeholders. Using first 3 animals as fallback.');
                chosen = animals.slice(0,3);
            }
            // ìš°ì„  ì‹¤ì œ ë§¤ì¹­ëœ chosen, ê·¸ ë‹¤ìŒ placeholder, ê·¸ ë‹¤ìŒ ë‹¤ë¥¸ ë™ë¬¼ë¡œ ì±„ì›€
            while (chosen.length < 3 && placeholders.length) {
                const ph = placeholders.shift();
                chosen.push(ph);
            }
            if (chosen.length < 3) {
                console.log(`[AI][DEBUG] Filling remaining slots with other animals. Current=${chosen.length}`);
                for (const dog of animals) {
                    if (!chosen.some(c => c.id === dog.id)) chosen.push(dog);
                    if (chosen.length === 3) break;
                }
            }
            if (chosen.length === 1) {
                console.warn('[AI][WARN] Still only one card after fill logic. Forcing two placeholder injections.');
                const needed = 3 - chosen.length;
                for (let i=0;i<needed;i++) {
                    chosen.push({ id:`force-ph-${i}`, placeholder:true, breedLabel: cls && cls.top ? (cls.top[i+1]||`ì¶”ê°€í›„ë³´${i+1}`) : `ì¶”ê°€í›„ë³´${i+1}`, score: (cls && cls.scores && cls.scores[i+1]!=null) ? Math.round(cls.scores[i+1]) : 50 });
                }
            }
            chosen = chosen.slice(0,3); // ensure max 3

            renderCards(chosen, simMap, cls);

            // Dots & nav
            if (document.querySelectorAll('#slider-track .result-card').length === 0){
                console.warn('[AI][FALLBACK] No cards rendered after renderCards(). Building from classify only.');
                buildFromClassifyOnly();
            }

            // ìµœì¢… ì•ˆì „ì¥ì¹˜: í˜¹ì‹œë¼ë„ í•œ ì¥ë§Œ ë Œë”ë˜ë©´ ì¦‰ì„ì—ì„œ 2ê°œ ë” ìƒì„±
            const finalCount = document.querySelectorAll('#slider-track .result-card').length;
            if (finalCount === 1) {
                console.warn('[AI][SAFEGUARD] Only one card after all logic. Injecting two debug placeholders.');
                for (let i=2;i<=3;i++) {
                    const ph = document.createElement('div');
                    ph.className = 'result-card';
                    ph.innerHTML = `
                        <img src="/assets/dog-placeholder.svg" alt="placeholder">
                        <div class="card-content">
                            <h3>ë””ë²„ê·¸ ì¹´ë“œ ${i} (ì„ì‹œ)</h3>
                            <div class="similarity-score" style="background-color:#E6F0FF;">âœ¨ í…ŒìŠ¤íŠ¸<span class="label">ê°•ì œ ìƒì„±ëœ ì¹´ë“œ</span></div>
                            <div class="matching-points"><strong>âœ”ï¸ ë””ë²„ê·¸</strong><div><span class="tag">#placeholder</span></div></div>
                        </div>`;
                    track.appendChild(ph);
                }
                // ë„¤ë¹„/ë„íŠ¸ ë‹¤ì‹œ êµ¬ì„±
                dotsWrap.innerHTML = '';
                const total2 = document.querySelectorAll('#slider-track .result-card').length;
                if (total2 > 1){
                    document.getElementById('prevBtn').style.display='flex';
                    document.getElementById('nextBtn').style.display='flex';
                    for (let i=0;i<total2;i++){
                        const b=document.createElement('button');
                        if (i===0) b.classList.add('active');
                        b.addEventListener('click', ()=>{ current=i; update(); });
                        dotsWrap.appendChild(b);
                    }
                    update();
                }
            }
        }
        document.addEventListener('DOMContentLoaded', ()=>{
            try { load(); } catch(e){ console.error('[AI][FATAL] load() crashed', e); buildFromClassifyOnly(); }
        });
        // ìˆ˜ë™ íŠ¸ë¦¬ê±°ë¥¼ ìœ„í•´ ì „ì—­ì— ë…¸ì¶œ
        window.__AI_FORCE_RENDER = buildFromClassifyOnly;
    </script>
</body>
</html>