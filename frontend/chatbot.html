<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì•„ì§€ ìƒì„¸ ì •ë³´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSSëŠ” ë³€ê²½ ì—†ìŒ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f7f2ea; color: #4a2c2a; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .typing-dot { animation: bounce 1s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body class="bg-[#f7f2ea]">

    <header class="bg-[#f0d8b6] p-4"></header>
    <main class="container mx-auto py-16 px-4">
        <div class="bg-white p-8 md:p-12 rounded-3xl card-shadow max-w-5xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mb-12">
                <div class="w-full">
                    <img id="main-dog-image" src="" alt="ê°•ì•„ì§€ ìƒì„¸ ì‚¬ì§„" class="w-full h-96 rounded-3xl object-cover mb-4 card-shadow">
                    <div id="thumbs" class="grid grid-cols-4 gap-4"></div>
                </div>
                <div class="w-full">
                    <h1 id="dog-name" class="text-5xl font-extrabold text-[#4a2c2a] mb-2"></h1>
                    <div id="dog-meta" class="flex items-center space-x-4 text-xl text-[#7a574b] mb-6"></div>
                    <div class="bg-[#f0d8b6]/50 p-6 rounded-2xl">
                        <h2 id="profile-title" class="text-2xl font-bold mb-4 text-[#4a2c2a]"></h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-base">
                            <div><strong class="font-semibold text-[#a9754f]">í’ˆì¢…</strong><p id="dog-breed">-</p></div>
                            <div><strong class="font-semibold text-[#a9754f]">í„¸ìƒ‰</strong><p id="dog-color">-</p></div>
                            <div><strong class="font-semibold text-[#a9754f]">ê±´ê°•/ìƒíƒœ</strong><p id="dog-status">-</p></div>
                            <div><strong class="font-semibold text-[#a9754f]">ì¼ë ¨ë²ˆí˜¸</strong><p id="dog-serial">-</p></div>
                            <div class="col-span-full"><strong class="font-semibold text-[#a9754f]">íŠ¹ì´ì‚¬í•­</strong><p id="dog-notes">-</p></div>
                        </div>
                    </div>
                </div>
            </div>
            <hr class="border-t-2 border-[#f0d8b6] my-12">
            <div class="w-full max-w-3xl mx-auto">
                <h2 id="chat-title" class="text-3xl font-bold mb-3 text-center"></h2>
                <p id="chat-subtitle" class="text-center text-[#7a574b] mb-8"></p>
                <div class="bg-white rounded-2xl card-shadow border-2 border-[#f0d8b6]">
                    <div class="bg-[#f0d8b6] p-4 rounded-t-2xl"><h3 id="chat-header" class="font-bold text-lg text-center"></h3></div>
                    <div id="chat-window" class="p-4 h-80 overflow-y-auto flex flex-col">
                        <div class="text-center my-auto">
                            <button id="start-chat-btn" class="bg-[#a9754f] hover:bg-[#7a574b] text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105">ëŒ€í™” ì‹œì‘í•˜ê¸°</button>
                        </div>
                    </div>
                    <div class="p-4 border-t border-[#f0d8b6]">
                        <div id="chat-input-container" class="flex items-center space-x-2 hidden">
                            <input type="text" id="user-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="flex-grow p-3 rounded-full border-2 border-[#a9754f] focus:outline-none focus:ring-2 focus:ring-[#a9754f] text-[#4a2c2a]">
                            <button id="send-btn" class="bg-[#a9754f] hover:bg-[#7a574b] text-white p-3 rounded-full shadow-md transition duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg></button>
                        </div>
                    </div>
                </div>
                <div id="recommendation-result" class="hidden mt-8 bg-white p-6 rounded-2xl card-shadow">
                    <h3 id="recommendation-title" class="text-2xl font-bold mb-4 text-[#4a2c2a]"></h3>
                    <div id="final-recommendation-text" class="text-[#4a2c2a] whitespace-pre-wrap"></div>
                </div>
            </div>
        </div>
    </main>
    <footer class="bg-[#7a574b] text-white py-8 rounded-t-3xl mt-16"></footer>

    <script>
        // HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°ëŠ” ë³€ê²½ ì—†ìŒ
        const mainImage = document.getElementById('main-dog-image');
        const thumbs = document.getElementById('thumbs');
        const chatWindow = document.getElementById('chat-window');
        const startChatBtn = document.getElementById('start-chat-btn');
        const chatInputContainer = document.getElementById('chat-input-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const recommendationResult = document.getElementById('recommendation-result');
        const finalRecommendationText = document.getElementById('final-recommendation-text');
    const AI_BASE = '/ai';
    const params = new URLSearchParams(window.location.search);
    const animalId = parseInt(params.get('id')) || 0;
    let currentAnimal = null;

        function findField(infoArr, key){
            for (const row of infoArr){
                if (row[0] === key) return row[1] || '';
                if (row[2] === key) return row[3] || '';
            }
            return '';
        }

    async function loadAnimal(){
            try {
                const res = await fetch(`${AI_BASE}/animals/${animalId}`);
                const item = await res.json();
        currentAnimal = item;
                const images = (item.gallery && item.gallery.length ? item.gallery : (item.images_mapped?.length ? item.images_mapped : item.images));
                if (images && images.length){
                    mainImage.src = images[0];
                    mainImage.onerror = () => { mainImage.src = '/assets/dog-placeholder.svg'; };
                    thumbs.innerHTML = '';
                    images.slice(0,4).forEach(src => {
                        const img = document.createElement('img');
                        img.src = src;
                        img.className = 'thumbnail-img rounded-lg h-24 w-full object-cover cursor-pointer hover:ring-2 ring-offset-2 ring-[#a9754f] transition';
                        img.onerror = () => { img.src = '/assets/dog-placeholder.svg'; };
                        img.addEventListener('click', ()=>{ mainImage.src = src; });
                        thumbs.appendChild(img);
                    });
                }
                const dogName = findField(item.info, 'ì´ë¦„') || 'ì´ë¦„ ë¯¸ìƒ';
                document.getElementById('dog-name').innerText = dogName;
                document.getElementById('profile-title').innerText = `${dogName}ì˜ í”„ë¡œí•„`;
                document.getElementById('chat-title').innerText = `${dogName}ì™€ ì§ì ‘ ëŒ€í™”í•´ ë³´ì„¸ìš”!`;
                document.getElementById('chat-subtitle').innerText = `${dogName}ì™€ì˜ ëŒ€í™”ë¥¼ í†µí•´ ì„¸ìƒì— ë‹¨ í•˜ë‚˜ë¿ì¸ ì…ì–‘ ì¶”ì²œì„œë¥¼ ë°›ì•„ë³´ì„¸ìš”.`;
                const age = findField(item.info, 'ë‚˜ì´(ì¶”ì •)');
                const gender = findField(item.info, 'ì„±ë³„');
                const weight = findField(item.info, 'ë¬´ê²Œ');
                document.getElementById('dog-breed').innerText = findField(item.info, 'í’ˆì¢…') || '-';
                document.getElementById('dog-color').innerText = findField(item.info, 'í„¸ìƒ‰') || '-';
                document.getElementById('dog-status').innerText = findField(item.info, 'ìƒíƒœ') || '-';
                document.getElementById('dog-serial').innerText = findField(item.info, 'ì¼ë ¨ë²ˆí˜¸') || '-';
                document.getElementById('dog-notes').innerText = findField(item.info, 'íŠ¹ì´ì‚¬í•­') || '-';
                document.getElementById('dog-meta').innerHTML = `${age ? `<span>${age}</span><span class="text-gray-300">|</span>`:''} ${gender? `<span>${gender}</span><span class=\"text-gray-300\">|</span>`:''} ${weight? `<span>${weight}</span>`:''}`;
                document.getElementById('chat-header').innerText = `${dogName}ì™€ì˜ ëŒ€í™” ğŸ’¬`;
                document.getElementById('recommendation-title').innerText = `ğŸ’Œ ${dogName}ê°€ ì „í•˜ëŠ” íŠ¹ë³„ ì¶”ì²œì„œ`;

                // ì§€ì—­/ë„ë©”ì¸ ì •ë³´ë¥¼ ë°˜ì˜í•˜ê³ , í•´ë‹¹ ê°•ì•„ì§€ í”„ë¡œí•„ì„ í¬í•¨í•œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                const region = 'ê´‘ì£¼';
                const preferredDomains = 'kcanimal.or.kr';
                const profileLines = [
                    `ì´ë¦„: ${dogName}`,
                    `í’ˆì¢…: ${findField(item.info,'í’ˆì¢…') || '-'}`,
                    `ë‚˜ì´(ì¶”ì •): ${age || '-'}`,
                    `ì„±ë³„: ${gender || '-'}`,
                    `ë¬´ê²Œ: ${weight || '-'}`,
                    `í„¸ìƒ‰: ${findField(item.info,'í„¸ìƒ‰') || '-'}`,
                    `ìƒíƒœ: ${findField(item.info,'ìƒíƒœ') || '-'}`,
                    `ì¼ë ¨ë²ˆí˜¸: ${findField(item.info,'ì¼ë ¨ë²ˆí˜¸') || '-'}`,
                    `íŠ¹ì´ì‚¬í•­: ${findField(item.info,'íŠ¹ì´ì‚¬í•­') || '-'}`,
                ].join('\n');

                systemPrompt = [
                    `ë‹¹ì‹ ì€ ê´‘ì£¼ì‹œ ìœ ê¸°ê²¬ ë³´í˜¸ì†Œì˜ ë°˜ë ¤ê²¬ ì±—ë´‡ì…ë‹ˆë‹¤. (SERVICE_REGION: ${region})`,
                    `í•­ìƒ ì•„ë˜ í”„ë¡œí•„ ì •ë³´ì— ê¸°ë°˜í•˜ì—¬ ëŒ€ë‹µí•˜ê³ , ëª¨ë¥´ëŠ” ì •ë³´ëŠ” ëª¨ë¥¸ë‹¤ê³  ë‹µí•˜ì„¸ìš”.`,
                    `ê°€ëŠ¥í•˜ë©´ ì¹œê·¼í•œ ê°•ì•„ì§€ ë§íˆ¬(ë©ë©, ì™ˆì™ˆ)ë¥¼ ì‚¬ìš©í•˜ë˜ ê³¼í•˜ì§€ ì•Šê²Œ ì •ì¤‘í•œ í•œêµ­ì–´ë¡œ ë‹µí•˜ì„¸ìš”.`,
                    `ë§í¬ë‚˜ ì°¸ê³ ìë£Œë¥¼ ì–¸ê¸‰í•  ê²½ìš° ë‹¤ìŒ ë„ë©”ì¸ì„ ìš°ì„ ì ìœ¼ë¡œ ê³ ë ¤í•˜ì„¸ìš”: ${preferredDomains}`,
                    `ì ˆëŒ€ í”„ë¡œí•„ì— ì—†ëŠ” ì‚¬ì‹¤ì„ ì§€ì–´ë‚´ì§€ ë§ˆì„¸ìš”(í—ˆêµ¬ ê¸ˆì§€).`,
                    `ëŒ€í™”ê°€ ì¶©ë¶„íˆ ì§„í–‰ë˜ì–´ ì‚¬ìš©ìê°€ ì¶”ì²œì„œë¥¼ ìš”ì²­í•˜ê±°ë‚˜ í•©ì˜í•˜ë©´, ë°˜ë“œì‹œ "ì¶”ì²œì„œ:"ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ë½ í•˜ë‚˜ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”. í•´ë‹¹ ë‹¨ë½ì—ëŠ” ì…ì–‘ì ë¼ì´í”„ìŠ¤íƒ€ì¼ ìš”ì•½(ëŒ€í™”ì—ì„œ ì¶”ì¶œ), ë°˜ë ¤ê²¬ì˜ ê°•ì , ì£¼ì˜ì‚¬í•­, ì²« ì¼ì£¼ì¼ ì ì‘ íŒ(í”„ë¡œí•„ì— ê·¼ê±°)ì„ ê°„ê²°íˆ í¬í•¨í•˜ì„¸ìš”.`,
                    `\n[ë°˜ë ¤ê²¬ í”„ë¡œí•„]\n${profileLines}`,
                ].join('\n');
            } catch (e){ console.error(e); }
        }
        
    let systemPrompt = `ë‹¹ì‹ ì€ ìœ ê¸°ê²¬ ìƒì„¸ í˜ì´ì§€ì˜ ë°˜ë ¤ê²¬ ì±—ë´‡ì…ë‹ˆë‹¤. ê°•ì•„ì§€ì²˜ëŸ¼ ì¹œê·¼í•˜ê²Œ ë§í•˜ê³ (ë©ë©, ì™ˆì™ˆ), ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— í•´ë‹¹ ê°•ì•„ì§€ì˜ í”„ë¡œí•„(í’ˆì¢…, ë‚˜ì´, ì„±ë³„, íŠ¹ì§•)ì— ë§ì¶° ëŒ€ë‹µí•˜ì„¸ìš”. ëŒ€í™”ê°€ ì¶©ë¶„íˆ ê¸¸ì–´ì§€ë©´ 'ì¶”ì²œì„œ:'ë¡œ ì‹œì‘í•˜ëŠ” ì…ì–‘ ì¶”ì²œì„œë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.`;
        let conversationHistory = [];

        // UI ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ë³€ê²½ ì—†ìŒ
        function appendMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message; 
            messageDiv.className = `p-3 rounded-xl mb-3 max-w-[80%] break-words ${sender === 'user' ? 'bg-[#a9754f] text-white self-end ml-auto' : 'bg-gray-200 text-[#4a2c2a] self-start mr-auto'}`;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'p-3 rounded-xl mb-3 max-w-[80%] bg-gray-200 text-[#4a2c2a] self-start mr-auto flex items-center space-x-1';
            typingDiv.innerHTML = `<div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div>`;
            chatWindow.appendChild(typingDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator')?.remove();
        }
        
async function getApiResponse(history) {
    try{
        const resp = await fetch(`${AI_BASE}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ system_prompt: systemPrompt, messages: history })
        });
        if (!resp.ok){ throw new Error('chat api failed'); }
        const data = await resp.json();
        return data.reply || 'ë©ë©?';
    } catch (e){
        console.error(e);
        return 'ë©ë©... ì§€ê¸ˆ ì„œë²„ì™€ ì—°ê²°ì´ ì–´ë ¤ì›Œìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
    }
}

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë“¤ì€ ë³€ê²½ ì—†ìŒ
        startChatBtn.addEventListener('click', () => {
            startChatBtn.parentElement.remove();
            chatInputContainer.classList.remove('hidden');
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                const dogName = currentAnimal ? (findField(currentAnimal.info,'ì´ë¦„') || 'ì €') : 'ì €';
                const firstMessage = `ë©ë©! ë°˜ê°€ì›Œìš”! ì €ëŠ” ${dogName}ì˜ˆìš”. ìƒˆë¡œìš´ ê°€ì¡±ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”. ê¶ê¸ˆí•œ ì ì´ ìˆë‚˜ìš”?`;
                appendMessage('chatbot', firstMessage);
                conversationHistory.push({ role: 'assistant', content: firstMessage });
            }, 1000);
        });

        const handleSend = async () => {
            const message = userInput.value.trim();
            if (message === '') return;
            
            appendMessage('user', message);
            userInput.value = '';
            conversationHistory.push({ role: 'user', content: message });

            showTypingIndicator();
            const botResponse = await getApiResponse(conversationHistory);
            hideTypingIndicator();
            
            if (botResponse.startsWith("ì¶”ì²œì„œ:")) {
                const recommendationText = botResponse.replace("ì¶”ì²œì„œ:", "").trim();
                finalRecommendationText.innerText = recommendationText;
                recommendationResult.classList.remove('hidden');
                chatInputContainer.classList.add('hidden');
            } else {
                 appendMessage('chatbot', botResponse);
                 conversationHistory.push({ role: 'assistant', content: botResponse });
            }
        };

        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });
        document.addEventListener('DOMContentLoaded', loadAnimal);
    </script>
</body>
</html>